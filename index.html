<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Examen Parcial - Régimen Legal - Despachantes de Aduana</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .student-info {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .student-info input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .timer {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .question-container {
            padding: 30px;
            display: none;
        }

        .question {
            margin-bottom: 30px;
            padding: 25px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .question h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .options {
            margin: 15px 0;
        }

        .option {
            margin: 10px 0;
            padding: 12px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .option.selected {
            background: #2196f3;
            color: white;
            border-color: #1976d2;
        }

        .fill-blank {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 5px;
            margin: 0 5px;
            min-width: 150px;
        }

        .buttons {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
        }

        .btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: background 0.3s ease;
        }

        .btn:hover {
            background: #1976d2;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .results {
            display: none;
            padding: 30px;
            text-align: center;
        }

        .score {
            font-size: 2rem;
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
        }

        .passed {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }

        .failed {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }

        .admin-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 2000;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1500;
        }

        .admin-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .timer {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 20px;
                display: inline-block;
            }
            
            .header h1 {
                font-size: 1.4rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Examen Parcial - Régimen Legal</h1>
            <p>Tecnicatura en Despachantes de Aduana</p>
        </div>

        <div id="student-form" class="student-info">
            <h2>Información del Estudiante</h2>
            <input type="text" id="student-name" placeholder="Nombre completo" required>
            <input type="text" id="student-dni" placeholder="DNI (solo números)" pattern="[0-9]+" required>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="startExam()">Comenzar Examen</button>
            </div>
        </div>

        <div id="timer" class="timer" style="display: none;">
            Tiempo restante: <span id="time">45:00</span>
        </div>

        <div id="exam-container" class="question-container">
            <!-- Las preguntas se generarán dinámicamente -->
        </div>

        <div class="buttons" id="exam-buttons" style="display: none;">
            <button class="btn btn-success" onclick="submitExam()">Entregar Examen</button>
        </div>

        <div id="results" class="results">
            <h2>Resultados del Examen</h2>
            <div id="score-display" class="score"></div>
            <div id="detailed-results"></div>
        </div>
    </div>

    <button class="admin-btn" onclick="showAdminPanel()">Admin</button>

    <div class="overlay" id="overlay" onclick="hideAdminPanel()"></div>
    <div class="admin-panel" id="admin-panel">
        <h3>Panel de Administrador</h3>
        <input type="password" id="admin-password" placeholder="Contraseña" value="admin123">
        <br><br>
        <button class="btn" onclick="downloadResults()">Descargar Resultados JSON</button>
        <button class="btn" onclick="hideAdminPanel()">Cerrar</button>
    </div>

    <script>
        // Datos del examen basados en el documento
        const examData = {
            questions: [
                {
                    id: 1,
                    type: 'multiple',
                    points: 1,
                    question: 'En base a la ley Aduanera y DNU 70/23, son despachantes de Aduana:',
                    options: [
                        'Las personas humanas o existencia visible realizan en nombre de otros ante el servicio aduanero trámites y diligencias relativos a la importación, la exportación.',
                        'Las personas jurídicas que realizan en nombre de otros ante el servicio aduanero trámites y diligencias relativos a la importación, la exportación.',
                        'Todas las opciones son utilizadas como despachantes de aduana.'
                    ],
                    correct: 2
                },
                {
                    id: 2,
                    type: 'multiple',
                    points: 1,
                    question: 'Las personas de existencia visible que, en las condiciones previstas en este código realizan en nombre de otros ante el servicio aduanero trámites y diligencias relativos a la importación, la exportación y demás operaciones aduaneras, son:',
                    options: [
                        'Auxiliares Comerciales y Fiscales',
                        'ATA y DA',
                        'Despachantes de Aduana'
                    ],
                    correct: 1
                },
                {
                    id: 3,
                    type: 'multiple',
                    points: 1,
                    question: 'Constitución Nacional - "Tesoro nacional formado del producto de los derechos Importación y exportación." Se expresa en el siguiente artículo:',
                    options: ['Art 4', 'Art 9', 'Art 12'],
                    correct: 0
                },
                {
                    id: 4,
                    type: 'multiple',
                    points: 1,
                    question: 'MERCOSUR - Sistema de Solución de Controversias se resuelve el 17 de diciembre de 1991 dentro del MERCOSUR:',
                    options: ['Protocolo de Ouro Preto', 'Protocolo de Brasilia', 'Tratado de Asunción'],
                    correct: 1
                },
                {
                    id: 5,
                    type: 'true_false_multiple',
                    points: 1,
                    question: 'Marque Verdadero (V) o Falso (F):',
                    statements: [
                        { text: 'El lecho y subsuelo submarinos nacionales no son parte del Territorio Aduanero.', correct: true },
                        { text: 'Zona marítima aduanera es el mar territorial argentino.', correct: false },
                        { text: 'El territorio Especial Aduanero o área aduanera especial es aquél en el cual es aplicable un sistema especial arancelario y control de mercaderías.', correct: true }
                    ]
                },
                {
                    id: 6,
                    type: 'fill_blank',
                    points: 1,
                    question: 'Leyes & Constitución - Indicar cuál es la ley (número) que ampara al comercio internacional en Argentina.',
                    correct: '22415'
                },
                {
                    id: 7,
                    type: 'true_false_multiple',
                    points: 1,
                    question: 'Marque Verdadero (V) o Falso (F):',
                    statements: [
                        { text: 'Garantía es todo derecho que se contrae a satisfacción de la aduana, con el objeto de asegurar el pago de los tributos aduaneros, sus intereses, actualizaciones, multas y otras responsabilidades.', correct: false },
                        { text: 'El MERCOSUR es un bloque social para mejorar el estilo de vida de los ciudadanos.', correct: false },
                        { text: 'Aduanas tiene competencia, es decir "quien dice la ley".', correct: false },
                        { text: 'Dentro del Código Aduanero, en la Sección XIII: se ocupa de las Infracciones Aduaneras de cualquier naturaleza.', correct: true },
                        { text: 'Una ley Federal puede ir en contra de la Constitución y Tratados internaciones porque es un juez nacional quien avala la decisión.', correct: false }
                    ]
                },
                {
                    id: 8,
                    type: 'true_false_multiple',
                    points: 1,
                    question: 'Marque Verdadero (V) o Falso (F):',
                    statements: [
                        { text: 'En la ley 22.415 en su estructura empieza con "Título Preliminar: Disposiciones Generales. Cap. 1: Ámbito espacial, Importación y exportación, mercaderías, etc."', correct: true },
                        { text: 'La zona Marítima aduanera rodea la franja del mar territorial argentino y los ríos internacionales sometida a la soberanía de la Nación Argentina, comprendidos sus espacios aéreos, que se encuentra sujeta a disposiciones especiales de control.', correct: true },
                        { text: 'Aduanas tiene jurisdicción, es decir "quien hace la ley".', correct: false },
                        { text: 'ART. 233 del C.A. (Código Aduanero) -- La destinación de importación para consumo es aquella en virtud de la cual la mercadería importada puede permanecer por tiempo determinado dentro del territorio aduanero.', correct: false }
                    ]
                },
                {
                    id: 9,
                    type: 'multiple_select',
                    points: 1,
                    question: 'Marcar todo aquello que no constituyen territorio Aduanero:',
                    options: ['Ríos Internacionales', 'Los Exclaves', 'Las Áreas Francas', 'Los Enclaves'],
                    correct: [0, 1, 2] // Índices de las opciones correctas
                },
                {
                    id: 10,
                    type: 'true_false_multiple',
                    points: 1,
                    question: 'Marque Verdadero (V) o Falso (F):',
                    statements: [
                        { text: 'Caracteres de la ley: Obligatoriedad, dado que emanan de poder público competente, lo que implica la existencia de una relación entre una autoridad que manda y de otros que obedecen, su observancia es obligatoria y puede exigirse su cumplimiento compulsivo (coercividad)', correct: true },
                        { text: 'Se entiende como concepto de ley a una norma económica obligatoria o activa dictada por una autoridad competente, que regula la relación del hombre en sociedad, y es la encargada de legislar.', correct: false },
                        { text: 'No constituye territorio aduanero, ni general ni especial a las áreas francas y enclaves.', correct: false },
                        { text: 'Dirección Regional de Posadas: Comprende a la totalidad de las jurisdicciones de las aduanas ubicadas en las provincias de Corrientes y Misiones.', correct: true }
                    ]
                },
                {
                    id: 11,
                    type: 'fill_multiple',
                    points: 1,
                    question: 'Indicar los 4 (cuatro) tipo de prohibiciones a las Mercaderías:',
                    blanks: ['ABSOLUTAS', 'RELATIVAS', 'ECONOMICAS', 'NO ECONOMICAS']
                },
                {
                    id: 12,
                    type: 'fill_multiple',
                    points: 1,
                    question: 'IMPORTACIONES - Indicar 3 tipos de destinaciones suspensivas:',
                    blanks: ['ALMACENAMIENTO', 'TRANSITO IMPORTACION', 'TEMPORAL']
                },
                {
                    id: 13,
                    type: 'true_false',
                    points: 1,
                    question: 'La Destinación Definitiva se pagan garantías',
                    correct: false
                },
                {
                    id: 14,
                    type: 'true_false',
                    points: 1,
                    question: 'El primer paso para realizar una destinación suspensiva es dar de alta la declaración en sistema informático Malvina',
                    correct: false
                },
                {
                    id: 15,
                    type: 'open',
                    points: 1,
                    question: 'Definir ¿a qué se llama procedencia y quien declara esta información?',
                    sample_answer: 'la mercadería se considera procedente del lugar del cual hubiera sido expedida con destino final al lugar de importación'
                }
            ]
        };

        let currentExam = {};
        let timeLeft = 45 * 60; // 45 minutes in seconds
        let timerInterval;
        let examResults = [];

        function startExam() {
            const name = document.getElementById('student-name').value.trim();
            const dni = document.getElementById('student-dni').value.trim();
            
            if (!name || !dni) {
                alert('Por favor complete todos los campos');
                return;
            }
            
            if (!/^\d+$/.test(dni)) {
                alert('El DNI debe contener solo números');
                return;
            }
            
            currentExam = {
                studentName: name,
                studentDNI: dni,
                startTime: new Date(),
                answers: {},
                timeSpent: 0
            };
            
            document.getElementById('student-form').style.display = 'none';
            document.getElementById('exam-container').style.display = 'block';
            document.getElementById('exam-buttons').style.display = 'block';
            document.getElementById('timer').style.display = 'block';
            
            generateQuestions();
            startTimer();
        }

        function generateQuestions() {
            const container = document.getElementById('exam-container');
            container.innerHTML = '';
            
            examData.questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                questionDiv.innerHTML = generateQuestionHTML(q, index);
                container.appendChild(questionDiv);
            });
        }

        function generateQuestionHTML(question, index) {
            let html = `<h3>Pregunta ${index + 1} (${question.points} punto${question.points > 1 ? 's' : ''})</h3>
                       <p><strong>${question.question}</strong></p>`;
            
            switch (question.type) {
                case 'multiple':
                    html += '<div class="options">';
                    question.options.forEach((option, i) => {
                        html += `<div class="option" onclick="selectOption(${question.id}, ${i})" data-question="${question.id}" data-option="${i}">
                                   ${option}
                                </div>`;
                    });
                    html += '</div>';
                    break;
                    
                case 'multiple_select':
                    html += '<div class="options">';
                    question.options.forEach((option, i) => {
                        html += `<div class="option" onclick="toggleMultipleOption(${question.id}, ${i})" data-question="${question.id}" data-option="${i}">
                                   <input type="checkbox" id="q${question.id}_${i}"> ${option}
                                </div>`;
                    });
                    html += '</div>';
                    break;
                    
                case 'true_false':
                    html += `<div class="options">
                               <div class="option" onclick="selectTrueFalse(${question.id}, true)">Verdadero</div>
                               <div class="option" onclick="selectTrueFalse(${question.id}, false)">Falso</div>
                             </div>`;
                    break;
                    
                case 'true_false_multiple':
                    question.statements.forEach((stmt, i) => {
                        html += `<div style="margin: 15px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                   <p>${stmt.text}</p>
                                   <div class="options">
                                     <div class="option" onclick="selectStatementTF(${question.id}, ${i}, true)">Verdadero</div>
                                     <div class="option" onclick="selectStatementTF(${question.id}, ${i}, false)">Falso</div>
                                   </div>
                                 </div>`;
                    });
                    break;
                    
                case 'fill_blank':
                    html += `<div style="margin: 15px 0;">
                               <input type="text" class="fill-blank" id="q${question.id}" placeholder="Escriba su respuesta">
                             </div>`;
                    break;
                    
        
                case 'fill_multiple':
                    if (userAnswer && Array.isArray(userAnswer)) {
                        let correctBlanks = 0;
                        
                        // Para cada respuesta del usuario, verificar si coincide con alguna respuesta correcta
                        userAnswer.forEach(userResp => {
                            if (userResp && userResp.trim()) {
                                const userRespClean = userResp.trim().toLowerCase();
                                // Verificar si esta respuesta coincide con alguna de las correctas
                                const matchFound = q.blanks.some(correctResp => 
                                    correctResp.toLowerCase().includes(userRespClean) || 
                                    userRespClean.includes(correctResp.toLowerCase())
                                );
                                if (matchFound) {
                                    correctBlanks++;
                                }
                            }
                        });
                        
                        // También verificar que no haya respuestas duplicadas contando respuestas únicas
                        const uniqueCorrectAnswers = new Set();
                        userAnswer.forEach(userResp => {
                            if (userResp && userResp.trim()) {
                                const userRespClean = userResp.trim().toLowerCase();
                                q.blanks.forEach(correctResp => {
                                    if (correctResp.toLowerCase().includes(userRespClean) || 
                                        userRespClean.includes(correctResp.toLowerCase())) {
                                        uniqueCorrectAnswers.add(correctResp.toLowerCase());
                                    }
                                });
                            }
                        });
                        
                        correctBlanks = Math.min(correctBlanks, uniqueCorrectAnswers.size);
                        questionPoints = (correctBlanks / q.blanks.length) * q.points;
                        isCorrect = correctBlanks === q.blanks.length;
                    }
                    break;
                    
                case 'open':
                    html += `<div style="margin: 15px 0;">
                               <textarea id="q${question.id}" rows="4" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;" placeholder="Escriba su respuesta completa..."></textarea>
                             </div>`;
                    break;
            }
            
            return html;
        }

        function selectOption(questionId, optionIndex) {
            // Remover selección previa
            document.querySelectorAll(`[data-question="${questionId}"]`).forEach(el => {
                el.classList.remove('selected');
            });
            // Seleccionar nueva opción
            document.querySelector(`[data-question="${questionId}"][data-option="${optionIndex}"]`).classList.add('selected');
            currentExam.answers[questionId] = optionIndex;
        }

        function toggleMultipleOption(questionId, optionIndex) {
            const checkbox = document.getElementById(`q${questionId}_${optionIndex}`);
            checkbox.checked = !checkbox.checked;
            
            if (!currentExam.answers[questionId]) {
                currentExam.answers[questionId] = [];
            }
            
            if (checkbox.checked) {
                if (!currentExam.answers[questionId].includes(optionIndex)) {
                    currentExam.answers[questionId].push(optionIndex);
                }
            } else {
                currentExam.answers[questionId] = currentExam.answers[questionId].filter(i => i !== optionIndex);
            }
        }

        function selectTrueFalse(questionId, value) {
            document.querySelectorAll(`[onclick*="${questionId}"]`).forEach(el => {
                el.classList.remove('selected');
            });
            event.target.classList.add('selected');
            currentExam.answers[questionId] = value;
        }

        function selectStatementTF(questionId, statementIndex, value) {
            if (!currentExam.answers[questionId]) {
                currentExam.answers[questionId] = {};
            }
            currentExam.answers[questionId][statementIndex] = value;
            
            // Visual feedback
            const options = event.target.parentElement.children;
            Array.from(options).forEach(opt => opt.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    alert('¡Tiempo agotado! El examen será enviado automáticamente.');
                    submitExam();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('time').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
            if (timeLeft <= 300) { // 5 minutes warning
                document.getElementById('timer').style.background = '#e74c3c';
            }
        }

        function collectAnswers() {
            // Recopilar respuestas de campos de texto y áreas de texto
            examData.questions.forEach(q => {
                if (q.type === 'fill_blank' || q.type === 'open') {
                    const element = document.getElementById(`q${q.id}`);
                    if (element && element.value.trim()) {
                        currentExam.answers[q.id] = element.value.trim();
                    }
                } else if (q.type === 'fill_multiple') {
                    const answers = [];
                    q.blanks.forEach((blank, i) => {
                        const element = document.getElementById(`q${q.id}_${i}`);
                        if (element && element.value.trim()) {
                            answers.push(element.value.trim());
                        }
                    });
                    if (answers.length > 0) {
                        currentExam.answers[q.id] = answers;
                    }
                }
            });
        }

        // Modificar la función submitExam para incluir validación
        function submitExam() {
            if (!validateExam()) {
                return;
            }
            
            clearInterval(timerInterval);
            collectAnswers();
            
            currentExam.endTime = new Date();
            currentExam.timeSpent = 45 * 60 - timeLeft;
            
            const results = calculateScore();
            
            const examResult = {
                ...currentExam,
                ...results,
                examDate: new Date().toISOString()
            };
            
            // Mostrar mensaje de envío
            const sendingMsg = document.createElement('div');
            sendingMsg.innerHTML = '<p style="text-align: center; padding: 20px;">📧 Enviando resultados al profesor...</p>';
            document.body.appendChild(sendingMsg);
            
            // Enviar por email
            sendResultsByEmail(examResult).then(success => {
                document.body.removeChild(sendingMsg);
                
                if (success) {
                    alert('✅ Examen enviado correctamente al profesor!');
                } else {
                    alert('⚠️ Hubo un problema al enviar el examen. Por favor contacte al profesor.');
                }
                
                showResults(results);
            });
            
            // Guardar localmente como respaldo
            examResults.push(examResult);
            localStorage.setItem('allExamResults', JSON.stringify(examResults));
        }
            
        function calculateScore() {
            let totalPoints = 0;
            let earnedPoints = 0;
            let detailedResults = [];
            
            examData.questions.forEach(q => {
                totalPoints += q.points;
                let questionPoints = 0;
                let isCorrect = false;
                
                const userAnswer = currentExam.answers[q.id];
                
                switch (q.type) {
                    case 'multiple':
                        isCorrect = userAnswer === q.correct;
                        questionPoints = isCorrect ? q.points : 0;
                        break;
                        
                    case 'multiple_select':
                        if (userAnswer && Array.isArray(userAnswer)) {
                            const correctSet = new Set(q.correct);
                            const userSet = new Set(userAnswer);
                            isCorrect = correctSet.size === userSet.size && 
                                       [...correctSet].every(x => userSet.has(x));
                        }
                        questionPoints = isCorrect ? q.points : 0;
                        break;
                        
                    case 'true_false':
                        isCorrect = userAnswer === q.correct;
                        questionPoints = isCorrect ? q.points : 0;
                        break;
                        
                    case 'true_false_multiple':
                        let correctStatements = 0;
                        q.statements.forEach((stmt, i) => {
                            if (userAnswer && userAnswer[i] === stmt.correct) {
                                correctStatements++;
                            }
                        });
                        questionPoints = (correctStatements / q.statements.length) * q.points;
                        isCorrect = correctStatements === q.statements.length;
                        break;
                        
                    case 'fill_blank':
                        if (userAnswer) {
                            isCorrect = userAnswer.toLowerCase().includes(q.correct.toLowerCase());
                            questionPoints = isCorrect ? q.points : 0;
                        }
                        break;
                        
                    case 'fill_multiple':
                        if (userAnswer && Array.isArray(userAnswer)) {
                            let correctBlanks = 0;
                            userAnswer.forEach(userResp => {
                                if (userResp && userResp.trim()) {
                                    const userRespClean = userResp.trim().toLowerCase();
                                    const matchFound = q.blanks.some(correctResp => 
                                        correctResp.toLowerCase().includes(userRespClean) || 
                                        userRespClean.includes(correctResp.toLowerCase())
                                    );
                                    if (matchFound) {
                                        correctBlanks++;
                                    }
                                }
                            });
                            
                            const uniqueCorrectAnswers = new Set();
                            userAnswer.forEach(userResp => {
                                if (userResp && userResp.trim()) {
                                    const userRespClean = userResp.trim().toLowerCase();
                                    q.blanks.forEach(correctResp => {
                                        if (correctResp.toLowerCase().includes(userRespClean) || 
                                            userRespClean.includes(correctResp.toLowerCase())) {
                                            uniqueCorrectAnswers.add(correctResp.toLowerCase());
                                        }
                                    });
                                }
                            });
                            
                            correctBlanks = Math.min(correctBlanks, uniqueCorrectAnswers.size);
                            questionPoints = (correctBlanks / q.blanks.length) * q.points;
                            isCorrect = correctBlanks === q.blanks.length;
                        }
                        break;
                        
                    case 'open':
                        if (userAnswer && userAnswer.length > 20) {
                            questionPoints = q.points * 0.8;
                            isCorrect = true;
                        }
                        break;
                }
                
                earnedPoints += questionPoints;
                detailedResults.push({
                    questionId: q.id,
                    question: q.question,
                    userAnswer: userAnswer,
                    isCorrect: isCorrect,
                    pointsEarned: questionPoints,
                    totalPoints: q.points
                });
            });
            
            const finalScore = (earnedPoints / totalPoints) * 10;
            const passed = finalScore >= 6;
            
            return {
                totalQuestions: examData.questions.length,
                totalPoints: totalPoints,
                earnedPoints: earnedPoints,
                finalScore: Math.round(finalScore * 100) / 100,
                passed: passed,
                detailedResults: detailedResults
            };
        }

        function showResults(results) {
            document.getElementById('exam-container').style.display = 'none';
            document.getElementById('exam-buttons').style.display = 'none';
            document.getElementById('timer').style.display = 'none';
            
            const resultsDiv = document.getElementById('results');
            const scoreDisplay = document.getElementById('score-display');
            const detailedResults = document.getElementById('detailed-results');
            
            scoreDisplay.innerHTML = `
                <h3>Puntuación Final: ${results.finalScore}/10</h3>
                <p>Puntos obtenidos: ${results.earnedPoints.toFixed(2)}/${results.totalPoints}</p>
                <p>Preguntas respondidas: ${results.totalQuestions}</p>
                <p>Tiempo utilizado: ${Math.floor(currentExam.timeSpent / 60)}:${(currentExam.timeSpent % 60).toString().padStart(2, '0')}</p>
            `;
            
            scoreDisplay.className = `score ${results.passed ? 'passed' : 'failed'}`;
            
            if (results.passed) {
                scoreDisplay.innerHTML += '<h4>¡APROBADO! 🎉</h4>';
            } else {
                scoreDisplay.innerHTML += '<h4>DESAPROBADO - Debe rendir recuperatorio 📚</h4>';
            }
            
            // Mostrar resultados detallados
            let detailedHTML = '<h3>Resultados por Pregunta:</h3>';
            results.detailedResults.forEach((result, index) => {
                const status = result.isCorrect ? '✅' : '❌';
                detailedHTML += `
                    <div style="margin: 10px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: ${result.isCorrect ? '#d4edda' : '#f8d7da'}">
                        <strong>Pregunta ${index + 1} ${status}</strong><br>
                        <em>${result.question}</em><br>
                        <strong>Puntos obtenidos:</strong> ${result.pointsEarned.toFixed(2)}/${result.totalPoints}
                    </div>
                `;
            });
            
            detailedResults.innerHTML = detailedHTML;
            resultsDiv.style.display = 'block';
        }

        function showAdminPanel() {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('admin-panel').style.display = 'block';
        }

        function hideAdminPanel() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'none';
        }

        function downloadResults() {
            const password = document.getElementById('admin-password').value;
            if (password !== 'admin123') {
                alert('Contraseña incorrecta');
                return;
            }
            
            if (examResults.length === 0) {
                alert('No hay resultados para descargar');
                return;
            }
            
            const dataStr = JSON.stringify(examResults, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `resultados_examen_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            hideAdminPanel();
        }

        // Funciones adicionales para manejar las preguntas que faltaban
        function updateQuestionPoints() {
            // Recalcular puntos por pregunta basado en el sistema especificado
            const totalQuestions = examData.questions.length;
            const pointsPerQuestion = 10 / totalQuestions;
            
            examData.questions.forEach(q => {
                q.points = pointsPerQuestion;
            });
        }

        // Función para prevenir que se cierre accidentalmente
        window.addEventListener('beforeunload', function(e) {
            if (document.getElementById('exam-container').style.display !== 'none') {
                e.preventDefault();
                e.returnValue = '¿Está seguro de que desea salir? Su progreso se perderá.';
            }
        });

        // Función para guardar progreso automáticamente
        function autoSave() {
            if (currentExam.studentName) {
                collectAnswers();
                localStorage.setItem('examProgress', JSON.stringify(currentExam));
            }
        }

        // Auto-guardar cada 30 segundos
        setInterval(autoSave, 30000);

        // Inicializar puntos al cargar
        document.addEventListener('DOMContentLoaded', function() {
            updateQuestionPoints();
        });

        // Función adicional para validar todas las respuestas antes de enviar
        
        // Modificar la función validateExam
        function validateExam() {
            const unanswered = [];
            examData.questions.forEach((q, index) => {
                const answer = currentExam.answers[q.id];
                let isAnswered = false;
                
                switch (q.type) {
                    case 'multiple':
                    case 'true_false':
                        isAnswered = answer !== undefined && answer !== null;
                        break;
                    case 'multiple_select':
                        isAnswered = answer && Array.isArray(answer) && answer.length > 0;
                        break;
                    case 'true_false_multiple':
                        isAnswered = answer && Object.keys(answer).length > 0;
                        break;
                    case 'fill_blank':
                    case 'open':
                        isAnswered = answer && answer.trim().length > 0;
                        break;
                    case 'fill_multiple':
                        isAnswered = answer && Array.isArray(answer) && answer.some(a => a && a.trim().length > 0);
                        break;
                }
                
                if (!isAnswered) {
                    unanswered.push(index + 1);
                }
            });
            
            if (unanswered.length > 0) {
                return confirm(`Tiene ${unanswered.length} pregunta(s) sin responder: ${unanswered.join(', ')}. ¿Desea enviar el examen de todas formas?`);
            }
            return true;
        }

        // Modificar la función submitExam para incluir validación
        const originalSubmitExam = submitExam;
        submitExam = function() {
            if (validateExam()) {
                originalSubmitExam();
            }
        }

   
    function formatDetailedResults(detailedResults) {
        let formatted = '';
        detailedResults.forEach((result, index) => {
            const status = result.isCorrect ? '✅' : '❌';
            formatted += `Pregunta ${index + 1} ${status}: ${result.pointsEarned.toFixed(2)}/${result.totalPoints} puntos\n`;
        });
        return formatted;
    }
        // Configuración de EmailJS - Reemplaza con tus datos reales
       
        (function(){
            emailjs.init("teKUO2cmPzDbfLcd2");
        })();
        
        const EMAIL_CONFIG = {
            serviceID: 'service_zal482d',
            templateID: 'template_5059mzm',
            toEmail: 'hcgalvantech@gmail.com'
        };        
        function sendResultsByEmail(examResult) {
            const templateParams = {
                to_email: EMAIL_CONFIG.toEmail,
                student_name: examResult.studentName,
                student_dni: examResult.studentDNI,
                final_score: examResult.finalScore,
                total_points: examResult.earnedPoints.toFixed(2),
                max_points: examResult.totalPoints,
                passed_status: examResult.passed ? 'APROBADO ✅' : 'DESAPROBADO ❌ (Recuperatorio)',
                exam_date: new Date(examResult.examDate).toLocaleString(),
                time_spent: `${Math.floor(examResult.timeSpent / 60)}:${(examResult.timeSpent % 60).toString().padStart(2, '0')}`,
                detailed_results: formatDetailedResults(examResult.detailedResults),
                total_questions: examResult.totalQuestions
            };
        
            return emailjs.send(EMAIL_CONFIG.serviceID, EMAIL_CONFIG.templateID, templateParams)
                .then(function(response) {
                    console.log('Email enviado correctamente!', response.status, response.text);
                    return true;
                })
                .catch(function(error) {
                    console.error('Error al enviar email:', error);
                    return false;
                });
        }
        
        function formatDetailedResults(detailedResults) {
            let formatted = '';
            detailedResults.forEach((result, index) => {
                const status = result.isCorrect ? '✅' : '❌';
                formatted += `Pregunta ${index + 1} ${status}: ${result.pointsEarned.toFixed(2)}/${result.totalPoints} puntos\n`;
            });
            return formatted;
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</body>
</html>    
